<?php

/**
 * Created by PhpStorm.
 * User: kostet
 * Date: 02.07.2017
 * Time: 14:51
 */
class ActivityStatusWithExtendedStatistic extends ActivityStatusBase
{
    public function getStatus()
    {
        $status = parent::getStatus(); // TODO: Change the autogenerated stub

        if ($status != ActivityModuleDescriptor::STATUS_NONE || !$this->dealer) {
            return $status;
        }

        $activityStatisticStatus = $this->activity->isActivityStatisticComplete($this->user, null, true,  $this->year, $this->quarter, $this->consider_activity_quarter ? array('check_by_quarter' => true) : null);

        if ($this->activity_models_created_count > 0 && !$activityStatisticStatus) {
            return ActivityModuleDescriptor::STATUS_WAIT_DEALER;
        } else if ($activityStatisticStatus) {
            $activityModelsComplete = AgreementModelTable::getInstance()
                ->createQuery('am')
                ->select('id')
                ->leftJoin('am.Report r')
                ->where('am.activity_id = ? and am.dealer_id = ?', array($this->activity->getId(), $this->dealer->getId()))
                //->andWhere('year(r.updated_at) = ? and quarter(r.updated_at) = ?', array($this->year, $this->quarter))
                ->andWhere('am.status = ? and r.status = ?', array('accepted', 'accepted'))
                ->andWhere('model_type_id != ?', Activity::CONCEPT_MODEL_TYPE_ID)
                ->orderBy('am.id ASC')
                ->execute(array(), Doctrine_Core::HYDRATE_ARRAY);

            if (count($activityModelsComplete) > 0) {
                return Utils::checkModelsCompleted($this->activity, $this->dealer, $this->year, $this->quarter) ? ActivityModuleDescriptor::STATUS_ACCEPTED : ActivityModuleDescriptor::STATUS_WAIT_DEALER;
            }

            return $this->activity_models_created_count > 0 ? ActivityModuleDescriptor::STATUS_WAIT_DEALER : ActivityModuleDescriptor::STATUS_NONE;
        }

        return ActivityModuleDescriptor::STATUS_NONE;
    }
}
