<?php

/**
 * ActivityExtendedStatisticSteps
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    Servicepool2.0
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class ActivityExtendedStatisticSteps extends BaseActivityExtendedStatisticSteps
{
    public function getSectionsList ()
    {
        $sections = array();
        $sections_result = array();
        $sections_ids = array();

        //Получаем список полей по шагу
        $fields_list = ActivityExtendedStatisticFieldsTable::getInstance()->createQuery()->where('step_id = ?', $this->getId())->orderBy('parent_id DESC')->execute();
        foreach ($fields_list as $field) {
            $section = $field->getSection();

            $sections_ids[ $section->getId() ] = $section->getId();
            $sections[ $section->getId() ][ 'fields_ids' ][] = $field->getId();
        }
        
        if (!empty($sections_ids)) {
            $sections_list = ActivityExtendedStatisticSectionsTable::getInstance()->createQuery()->whereIn('id', $sections_ids)->orderBy('position ASC')->execute();

            //Получаем список корректно отсортированных полей
            foreach ($sections_list as $section) {
                $sections_result[ $section->getId() ][ 'data' ] = $section->getHeader();

                $data = $sections[ $section->getId() ];
                $fields_list = ActivityExtendedStatisticFieldsTable::getInstance()->createQuery()->whereIn('id', $data[ 'fields_ids' ])->orderBy('position ASC')->execute();

                $sections_result[ $section->getId() ][ 'fields' ] = array();
                foreach ($fields_list as $field) {
                    $sections_result[ $section->getId() ][ 'fields' ][] = $field;
                }
            }
        }

        return $sections_result;
    }
}
