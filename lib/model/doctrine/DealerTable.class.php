<?php

/**
 * DealerTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class DealerTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object DealerTable
     */
    static function getInstance()
    {
        return Doctrine_Core::getTable('Dealer');
    }

    /**
     * Returns query to query all volkswagen dealers
     *
     * @return Doctrine_Query
     */
    static function getVwDealersQuery($limit = null, $offset = null)
    {
        $query = self::getInstance()->createQuery('d')->where('importer_id = ?', array(1));
        self::queryByNumber($query);

        //$query = self::getInstance()->createQuery('d')->where('importer_id=?', array(1))->andWhere('number LIKE ?', '93500%');

        if (($limit == null) or ($offset == null))
            return $query->andWhere('dealer_type IN (1,3)')->orderBy('number');
        else
            return $query->offset($offset)->limit($limit)->orderBy('number');
    }

    public static function getDealersList()
    {
        $query = self::getInstance()->createQuery('d')->where('importer_id = ?', array(1));
        self::queryByNumber($query);

        return $query->orderBy('number');
    }

    public static function getActiveDealersList()
    {
        $query = self::getInstance()->createQuery('d')
            ->where('importer_id = ? and status = ? and dealer_type != ?', array(1, true, Dealer::TYPE_NFZ));
        self::queryByNumber($query);

        return $query->orderBy('number');
    }

    public static function getAllDealers() {
        $query = self::getInstance()->createQuery('d');
        self::queryByNumber($query);

        return $query->orderBy('number');
    }

    /**
     * Делаем запрос по номерам стран доступных для сп2
     * @param $query
     */
    public static function queryByNumber(&$query) {
        $query_str = array();
        $query_params = array();

        $numbers = self::getAvailableDealersCountries();
        foreach ($numbers as $number) {
            $query_str[] = 'number LIKE ?';
            $query_params[] = $number.'%';
        }

        $query->andWhere('(' . implode(' or ', $query_str). ')', $query_params);
    }

    /**
     * Список номеров стран с регистрацией дилеров
     * @return array
     */
    public static function getAvailableDealersCountries() {
        return explode(',', sfConfig::get('app_available_dealers_countries'));
    }
}
