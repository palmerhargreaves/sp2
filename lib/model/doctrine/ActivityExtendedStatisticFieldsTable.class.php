<?php

/**
 * ActivityExtendedStatisticFieldsTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ActivityExtendedStatisticFieldsTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object ActivityExtendedStatisticFieldsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('ActivityExtendedStatisticFields');
    }

    /**
     * @param $user
     * @param null $activity
     * @param int $current_year
     * @param int $current_q
     * @return null|string
     */
    public static function getConceptInfoByUserActivity( $user, $activity = null, $current_year = 0, $current_q = 0)
    {
        $user = $user->getAuthUser();

        $userDealer = $user->getDealerUsers()->getFirst();
        $dealer = null;
        if ($userDealer)
            $dealer = DealerTable::getInstance()->createQuery('d')->where('id = ?', $userDealer->getDealerId())->fetchOne();

        if (!$dealer)
            return '';

        $query = ActivityExtendedStatisticFieldsDataTable::getInstance()->createQuery()->where('dealer_id = ?', array($dealer->getId()))->groupBy('concept_id');
        if (!is_null($activity)) {
            $query->andWhere('activity_id = ?', $activity->getId());
        }

        if ($current_year != 0) {
            $query->andWhere('year = ?', $current_year);
        }

        if ($current_q != 0) {
            $query->andWhere('quarter = ?', $current_q);
        }
        $concepts = $query->execute();

        if ($concepts && $concepts->count() > 0 && $concepts->getFirst()->getConceptId() != 0) {
            return $concepts->getFirst()->getConceptId();
        }

        return null;
    }

    public static function checkUserConcept($user, $concept)
    {
        if (is_numeric($user)) {
            $dealerId = $user;
        } else {
            $user = $user->getAuthUser();

            $userDealer = $user->getDealerUsers()->getFirst();
            $dealer = null;
            if ($userDealer)
                $dealer = DealerTable::getInstance()->createQuery('d')->where('id = ?', $userDealer->getDealerId())->fetchOne();

            if (!$dealer)
                return '';

            $dealerId = $dealer->getId();
        }

        //$field = ActivityExtendedStatisticFieldsDataTable::getInstance()->createQuery()->where('field_id = ? and user_id = ? and dealer_id = ?', array($this->getId(), $user->getId(), $dealer->getId()))->fetchOne();
        if (ActivityExtendedStatisticFieldsDataTable::getInstance()->createQuery()->where('dealer_id = ? and concept_id = ?', array($dealerId, $concept->getId()))->count() > 0) {
            return true;
        }

        return null;
    }
}
