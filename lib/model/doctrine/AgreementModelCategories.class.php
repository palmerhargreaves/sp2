<?php

/**
 * AgreementModelCategories
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    Servicepool2.0
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class AgreementModelCategories extends BaseAgreementModelCategories
{

    const WORK_TYPE_MANAGER = 'manager';
    const WORK_TYPE_MANAGER_DESIGNER = 'isValidModelCategory';

    public static function getModelStatus(AgreementModel $model) {
        $label = "Внесите коментарии менеджера. ";

        if ($model->getManagerStatus() == 'declined' && $model->getDesignerStatus() == 'wait') {
            $label = "Внесите коментарии менеджера. ";
        } else if ($model->getDesignerStatus() == 'declined') {
            $label = "Внесите коментарии дизайнера. ";
        } else if ($model->getManagerStatus() == 'wait' && $model->getDesignerStatus() == 'wait') {
            $label = "Внесите коментарии менеджера. ";
        }

        return $label;
    }

    public function getWorkTypeLabel() {
        return $this->getWorkType() == 'manager' ? 'Менеджер' : 'Менеджер / Дизайнер';
    }

    public function getCategoryTypesListOrderedByPosition() {
        return AgreementModelTypeTable::getInstance()->createQuery()->where('parent_category_id = ?', $this->getId())->orderBy('position ASC')->execute();
    }

    public function getCategoryFieldsListOrderedByPosition() {
        return AgreementModelFieldTable::getInstance()->createQuery()
            ->where('parent_category_id = ? and hide = ?', array($this->getId(), false))
            ->orderBy('position ASC')
            ->execute();
    }

    public function isManager() {
        return $this->getWorkType() == 'manager' ? true : false;
    }

    public function isManagerDesigner() {
        return $this->getWorkType() == 'manager_designer' ? true : false;
    }

    /**
     * Get model category agreement class, if use parameter external_cls we use this class
     * @param string $external_cls
     * @return string
     */
    public function getAgreementClass($external_cls = '') {
        $cls = 'AgreementModelBy'.ucfirst($this->getWorkType());

        //If category is blank (old models) set agreement class to manager
        if ($this->getIsBlank()) {
            $cls = 'AgreementModelByManager';
        } else {
            if ($this->isManagerDesigner()) {
                $cls = 'AgreementModelBy' . implode('', array_map(function ($item) {
                        return ucfirst($item);
                    }, explode('_', $this->getWorkType())));
            }
        }

        if (!empty($external_cls)) {
            $cls = 'AgreementModelBy'.ucfirst($external_cls);
        }

        return $cls;
    }

    /**
     * Get category fields list with combine by children field
     * @return array
     */
    public function getCategoryFields() {
        $fields_result = array();
        $fields_ids = array();

        $fields = $this->getFields();
        foreach ($fields as $field) {
            if (!array_key_exists($field->getId(), $fields_ids)) {
                $fields_result[] = $field;
            }

            if ($field->getChildField()) {
                $child_fields_list = $field->getChildFields();
                foreach ($child_fields_list as $child_item) {
                    $fields_result[] = $child_item;

                    $fields_ids[$child_item->getId()] = $child_item->getId();
                }
            }
        }

        return $fields_result;
    }
}
